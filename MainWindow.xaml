<Window x:Class="MaoJi.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:MaoJi.ViewModels"
        mc:Ignorable="d"
        Title="猫记" 
        Height="600" 
        Width="800"
        MinHeight="400"
        MinWidth="500"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        Closing="Window_Closing">
    
    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>

    <Window.Resources>
        <!-- 猫咪图标 -->
        <Geometry x:Key="CatIconGeometry">
            M12,8L10.67,8.09C9.81,7.07 7.4,4.5 5,4.5C5,4.5 3.03,7.46 4.96,11.41C4.41,12.24 4.07,12.67 4,13.66L2.07,13.95L2.28,14.93L4.04,14.67L4.18,15.38L2.61,16.32L3.08,17.21L4.53,16.32C5.68,18.76 8.59,20 12,20C15.41,20 18.32,18.76 19.47,16.32L20.92,17.21L21.39,16.32L19.82,15.38L19.96,14.67L21.72,14.93L21.93,13.95L20,13.66C19.93,12.67 19.59,12.24 19.04,11.41C20.97,7.46 19,4.5 19,4.5C16.6,4.5 14.19,7.07 13.33,8.09L12,8M9,11A1,1 0 0,1 10,12A1,1 0 0,1 9,13A1,1 0 0,1 8,12A1,1 0 0,1 9,11M15,11A1,1 0 0,1 16,12A1,1 0 0,1 15,13A1,1 0 0,1 14,12A1,1 0 0,1 15,11M11,14H13V15H11V14M12,17.5C10.06,17.5 8.5,17.33 8.5,17H15.5C15.5,17.33 13.94,17.5 12,17.5Z
        </Geometry>
        <Geometry x:Key="PinIconGeometry">
            M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12Z
        </Geometry>
        <Geometry x:Key="SearchIconGeometry">
            M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z
        </Geometry>
        <Geometry x:Key="MoonIconGeometry">
            M17.75,4.09L15.22,6.03L16.13,9.09L13.5,7.28L10.87,9.09L11.78,6.03L9.25,4.09L12.44,4L13.5,1L14.56,4L17.75,4.09M21.25,11L19.61,12.25L20.2,14.23L18.5,13.06L16.8,14.23L17.39,12.25L15.75,11L17.81,10.95L18.5,9L19.19,10.95L21.25,11M18.97,15.95C19.8,15.87 20.69,17.05 20.16,17.8C19.84,18.25 19.5,18.67 19.08,19.07C15.17,23 8.84,23 4.94,19.07C1.03,15.17 1.03,8.83 4.94,4.93C5.34,4.53 5.76,4.17 6.21,3.85C6.96,3.32 8.14,4.21 8.06,5.04C7.79,7.9 8.75,10.87 10.95,13.06C13.14,15.26 16.1,16.22 18.97,15.95Z
        </Geometry>
        <Geometry x:Key="SunIconGeometry">
            M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,2L14.39,5.42C13.65,5.15 12.84,5 12,5C11.16,5 10.35,5.15 9.61,5.42L12,2M3.34,7L7.5,6.65C6.9,7.16 6.36,7.78 5.94,8.5C5.5,9.24 5.25,10 5.11,10.79L3.34,7M3.36,17L5.12,13.23C5.26,14 5.53,14.78 5.95,15.5C6.37,16.24 6.91,16.86 7.5,17.37L3.36,17M20.65,7L18.88,10.79C18.74,10 18.47,9.23 18.05,8.5C17.63,7.78 17.1,7.15 16.5,6.64L20.65,7M20.64,17L16.5,17.36C17.09,16.85 17.62,16.22 18.04,15.5C18.46,14.77 18.73,14 18.87,13.21L20.64,17M12,22L9.59,18.56C10.33,18.83 11.14,19 12,19C12.82,19 13.63,18.83 14.37,18.56L12,22Z
        </Geometry>
        <Geometry x:Key="AddIconGeometry">
            M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z
        </Geometry>
        <Geometry x:Key="CloseIconGeometry">
            M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z
        </Geometry>
        <Geometry x:Key="OpenIconGeometry">
            M19,20H5V8H19M16,2H8A3,3 0 0,0 5,5V6H19V5A3,3 0 0,0 16,2M19,15H15V17H19V15M19,11H15V13H19V11Z
        </Geometry>
        <Geometry x:Key="SaveIconGeometry">
            M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z
        </Geometry>
        <Geometry x:Key="SaveAsIconGeometry">
            M5,21H19A2,2 0 0,0 21,19V7L17,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21M5,5H17V9H5V5M17,12V14H8V12H17M14,16V18H8V16H14Z
        </Geometry>
        <Geometry x:Key="CopyIconGeometry">
            M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z
        </Geometry>
    </Window.Resources>

    <Window.InputBindings>
        <KeyBinding Key="N" Modifiers="Ctrl" Command="{Binding NewTabCommand}"/>
        <KeyBinding Key="O" Modifiers="Ctrl" Command="{Binding OpenFileCommand}"/>
        <KeyBinding Key="S" Modifiers="Ctrl" Command="{Binding SaveFileCommand}"/>
        <KeyBinding Key="S" Modifiers="Ctrl+Shift" Command="{Binding SaveFileAsCommand}"/>
        <KeyBinding Key="F" Modifiers="Ctrl" Command="{Binding ToggleFindReplaceCommand}"/>
        <KeyBinding Key="H" Modifiers="Ctrl" Command="{Binding ToggleFindReplaceCommand}"/>
        <KeyBinding Key="W" Modifiers="Ctrl" Command="{Binding CloseTabCommand}" CommandParameter="{Binding SelectedTab}"/>
        <KeyBinding Key="F3" Command="{Binding FindNextCommand}"/>
        <KeyBinding Key="F3" Modifiers="Shift" Command="{Binding FindPreviousCommand}"/>
    </Window.InputBindings>

    <Border x:Name="MainBorder" 
            CornerRadius="12" 
            Opacity="{Binding WindowOpacity}"
            Background="{DynamicResource WindowBackgroundBrush}"
            BorderBrush="{DynamicResource BorderBrush}"
            BorderThickness="1">
        <Border.Effect>
            <DropShadowEffect BlurRadius="20" 
                            ShadowDepth="3" 
                            Opacity="0.25"
                            Color="#000000"/>
        </Border.Effect>
        
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="44"/>
                <RowDefinition Height="38"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="28"/>
            </Grid.RowDefinitions>

            <!-- 标题栏 -->
            <Border Grid.Row="0" 
                    Background="{DynamicResource SecondaryBackgroundBrush}"
                    CornerRadius="12,12,0,0"
                    MouseLeftButtonDown="TitleBar_MouseLeftButtonDown">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- 应用图标和标题 -->
                    <StackPanel Grid.Column="0" 
                              Orientation="Horizontal" 
                              VerticalAlignment="Center"
                              Margin="16,0,0,0">
                        <Path Data="{StaticResource CatIconGeometry}" 
                            Fill="{DynamicResource PrimaryBrush}"
                            Width="22" Height="22"
                            Stretch="Uniform"/>
                        <TextBlock Text="猫记" 
                                 FontSize="15" 
                                 FontWeight="SemiBold"
                                 Foreground="{DynamicResource PrimaryTextBrush}"
                                 VerticalAlignment="Center"
                                 Margin="10,0,0,0"/>
                        
                        <!-- 文件操作按钮组 -->
                        <StackPanel Orientation="Horizontal" Margin="24,0,0,0">
                            <Button Style="{DynamicResource ToolButtonStyle}"
                                  Command="{Binding OpenFileCommand}"
                                  ToolTip="打开文件 (Ctrl+O)"
                                  Padding="8,6">
                                <Path Data="{StaticResource OpenIconGeometry}" 
                                    Fill="{DynamicResource SecondaryTextBrush}"
                                    Width="14" Height="14"
                                    Stretch="Uniform"/>
                            </Button>
                            <Button Style="{DynamicResource ToolButtonStyle}"
                                  Command="{Binding SaveFileCommand}"
                                  ToolTip="保存 (Ctrl+S)"
                                  Padding="8,6"
                                  Margin="4,0,0,0">
                                <Path Data="{StaticResource SaveIconGeometry}" 
                                    Fill="{DynamicResource SecondaryTextBrush}"
                                    Width="14" Height="14"
                                    Stretch="Uniform"/>
                            </Button>
                            <Button Style="{DynamicResource ToolButtonStyle}"
                                  Command="{Binding SaveFileAsCommand}"
                                  ToolTip="另存为 (Ctrl+Shift+S)"
                                  Padding="8,6"
                                  Margin="4,0,0,0">
                                <Path Data="{StaticResource SaveAsIconGeometry}" 
                                    Fill="{DynamicResource SecondaryTextBrush}"
                                    Width="14" Height="14"
                                    Stretch="Uniform"/>
                            </Button>
                        </StackPanel>
                    </StackPanel>

                    <!-- 工具栏 -->
                    <StackPanel Grid.Column="2" 
                              Orientation="Horizontal" 
                              VerticalAlignment="Center"
                              Margin="0,0,12,0">
                        
                        <!-- 置顶按钮 -->
                        <ToggleButton Style="{DynamicResource ToggleButtonStyle}"
                                    IsChecked="{Binding IsTopmost, Mode=TwoWay}"
                                    ToolTip="置顶窗口"
                                    Command="{Binding ToggleTopmostCommand}"
                                    Click="TopmostButton_Click"
                                    Padding="8,6">
                            <Path Data="{StaticResource PinIconGeometry}" 
                                Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=ToggleButton}}"
                                Width="16" Height="16"
                                Stretch="Uniform"/>
                        </ToggleButton>

                        <!-- 透明度滑块 -->
                        <StackPanel Orientation="Horizontal" 
                                  VerticalAlignment="Center" 
                                  Margin="12,0">
                            <TextBlock Text="透明" 
                                     FontSize="12"
                                     Foreground="{DynamicResource SecondaryTextBrush}"
                                     VerticalAlignment="Center"/>
                            <Slider Style="{DynamicResource OpacitySliderStyle}"
                                  Value="{Binding WindowOpacity}"
                                  Margin="8,0,0,0"/>
                        </StackPanel>

                        <Rectangle Width="1" 
                                 Height="20" 
                                 Fill="{DynamicResource BorderBrush}"
                                 Margin="4,0"/>

                        <!-- 查找按钮 -->
                        <Button Style="{DynamicResource ToolButtonStyle}"
                              Command="{Binding ToggleFindReplaceCommand}"
                              ToolTip="查找/替换 (Ctrl+F)"
                              Padding="8,6">
                            <Path Data="{StaticResource SearchIconGeometry}" 
                                Fill="{DynamicResource PrimaryTextBrush}"
                                Width="16" Height="16"
                                Stretch="Uniform"/>
                        </Button>

                        <!-- 主题切换 -->
                        <ToggleButton Style="{DynamicResource ToggleButtonStyle}"
                                    IsChecked="{Binding IsDarkTheme, Mode=TwoWay}"
                                    Command="{Binding ToggleThemeCommand}"
                                    Click="ThemeButton_Click"
                                    ToolTip="切换主题"
                                    Padding="8,6">
                            <Path x:Name="ThemeIcon"
                                Data="{StaticResource MoonIconGeometry}" 
                                Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=ToggleButton}}"
                                Width="16" Height="16"
                                Stretch="Uniform"/>
                        </ToggleButton>
                    </StackPanel>

                    <!-- 窗口控制按钮 -->
                    <StackPanel Grid.Column="3" 
                              Orientation="Horizontal" 
                              VerticalAlignment="Center"
                              Margin="0,0,4,0">
                        <Button Style="{DynamicResource ToolButtonStyle}"
                              Click="MinimizeButton_Click"
                              ToolTip="最小化"
                              Padding="12,8">
                            <TextBlock Text="─" FontSize="11" FontWeight="Bold"/>
                        </Button>
                        <Button Style="{DynamicResource ToolButtonStyle}"
                              Click="MaximizeButton_Click"
                              ToolTip="最大化"
                              Padding="12,8">
                            <TextBlock Text="□" FontSize="11"/>
                        </Button>
                        <Button Style="{DynamicResource ToolButtonStyle}"
                              Click="CloseButton_Click"
                              ToolTip="关闭"
                              Padding="12,8">
                            <Path Data="{StaticResource CloseIconGeometry}" 
                                Fill="#E85D5D"
                                Width="12" Height="12"
                                Stretch="Uniform"/>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- 标签栏 -->
            <Border Grid.Row="1" Background="{DynamicResource SecondaryBackgroundBrush}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- 标签页列表 -->
                    <ScrollViewer Grid.Column="0" 
                                HorizontalScrollBarVisibility="Hidden" 
                                VerticalScrollBarVisibility="Disabled"
                                PreviewMouseWheel="ScrollViewer_PreviewMouseWheel"
                                Margin="8,0,0,0">
                        <ItemsControl ItemsSource="{Binding Tabs}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Horizontal"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border x:Name="TabBorder"
                                          Background="Transparent"
                                          CornerRadius="8,8,0,0"
                                          Margin="2,4,0,0"
                                          Padding="12,6,8,6"
                                          Cursor="Hand"
                                          MouseLeftButtonDown="Tab_MouseLeftButtonDown">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{Binding DisplayTitle}"
                                                     Foreground="{DynamicResource SecondaryTextBrush}"
                                                     FontSize="13"
                                                     VerticalAlignment="Center"
                                                     MaxWidth="150"
                                                     TextTrimming="CharacterEllipsis"/>
                                            <Button Style="{DynamicResource ToolButtonStyle}"
                                                  Padding="6,2"
                                                  Margin="8,0,0,0"
                                                  Command="{Binding DataContext.CloseTabCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                  CommandParameter="{Binding}"
                                                  Opacity="0.6">
                                                <Path Data="{StaticResource CloseIconGeometry}" 
                                                    Fill="{DynamicResource SecondaryTextBrush}"
                                                    Width="8" Height="8"
                                                    Stretch="Uniform"/>
                                            </Button>
                                        </StackPanel>
                                    </Border>
                                    <DataTemplate.Triggers>
                                        <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                            <Setter TargetName="TabBorder" Property="Background" Value="{DynamicResource ContentBackgroundBrush}"/>
                                        </DataTrigger>
                                        <Trigger SourceName="TabBorder" Property="IsMouseOver" Value="True">
                                            <Setter TargetName="TabBorder" Property="Background" Value="{DynamicResource HoverBrush}"/>
                                        </Trigger>
                                    </DataTemplate.Triggers>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>

                    <!-- 新建标签按钮 -->
                    <Button Grid.Column="1"
                          Style="{DynamicResource ToolButtonStyle}"
                          Command="{Binding NewTabCommand}"
                          ToolTip="新建标签页 (Ctrl+N)"
                          Margin="4,4,12,0"
                          Padding="10,6">
                        <Path Data="{StaticResource AddIconGeometry}" 
                            Fill="{DynamicResource PrimaryTextBrush}"
                            Width="14" Height="14"
                            Stretch="Uniform"/>
                    </Button>
                </Grid>
            </Border>

            <!-- 查找/替换面板 -->
            <Border Grid.Row="2" 
                  Background="{DynamicResource SecondaryBackgroundBrush}"
                  BorderBrush="{DynamicResource BorderBrush}"
                  BorderThickness="0,0,0,1"
                  Padding="16,10"
                  Visibility="{Binding IsFindReplaceVisible, Converter={StaticResource BoolToVisibilityConverter}}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*" MaxWidth="240"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*" MaxWidth="240"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" 
                             Text="查找" 
                             FontSize="12"
                             Foreground="{DynamicResource SecondaryTextBrush}"
                             VerticalAlignment="Center"
                             Margin="0,0,10,0"/>
                    
                    <TextBox Grid.Column="1" 
                           Style="{DynamicResource SearchTextBoxStyle}"
                           Text="{Binding FindText, UpdateSourceTrigger=PropertyChanged}"/>

                    <TextBlock Grid.Column="2" 
                             Text="替换" 
                             FontSize="12"
                             Foreground="{DynamicResource SecondaryTextBrush}"
                             VerticalAlignment="Center"
                             Margin="20,0,10,0"/>
                    
                    <TextBox Grid.Column="3" 
                           Style="{DynamicResource SearchTextBoxStyle}"
                           Text="{Binding ReplaceText, UpdateSourceTrigger=PropertyChanged}"/>

                    <StackPanel Grid.Column="4" Orientation="Horizontal" Margin="16,0,0,0">
                        <Button Style="{DynamicResource ToolButtonStyle}"
                              Command="{Binding FindPreviousCommand}"
                              ToolTip="上一个 (Shift+F3)"
                              Padding="8,4">
                            <TextBlock Text="◀" FontSize="10"/>
                        </Button>
                        <Button Style="{DynamicResource ToolButtonStyle}"
                              Command="{Binding FindNextCommand}"
                              ToolTip="下一个 (F3)"
                              Padding="8,4">
                            <TextBlock Text="▶" FontSize="10"/>
                        </Button>
                        <Rectangle Width="1" Height="16" Fill="{DynamicResource BorderBrush}" Margin="8,0"/>
                        <Button Style="{DynamicResource ToolButtonStyle}"
                              Command="{Binding ReplaceCommand}"
                              Content="替换"
                              FontSize="12"
                              Padding="10,4"/>
                        <Button Style="{DynamicResource ToolButtonStyle}"
                              Command="{Binding ReplaceAllCommand}"
                              Content="全部"
                              FontSize="12"
                              Padding="10,4"/>
                        <CheckBox Content="Aa" 
                                IsChecked="{Binding IsCaseSensitive}"
                                ToolTip="区分大小写"
                                Foreground="{DynamicResource SecondaryTextBrush}"
                                FontSize="11"
                                VerticalAlignment="Center"
                                Margin="12,0,0,0"/>
                        <Button Style="{DynamicResource ToolButtonStyle}"
                              Command="{Binding ToggleFindReplaceCommand}"
                              ToolTip="关闭"
                              Padding="8,4"
                              Margin="8,0,0,0">
                            <Path Data="{StaticResource CloseIconGeometry}" 
                                Fill="{DynamicResource SecondaryTextBrush}"
                                Width="10" Height="10"
                                Stretch="Uniform"/>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- 编辑区域 -->
            <Border Grid.Row="3" 
                  Background="{DynamicResource ContentBackgroundBrush}"
                  Margin="10,8,10,0"
                  CornerRadius="8">
                <TextBox x:Name="EditorTextBox"
                       Style="{DynamicResource EditorTextBoxStyle}"
                       Text="{Binding SelectedTab.Content, UpdateSourceTrigger=PropertyChanged}"
                       SelectionChanged="EditorTextBox_SelectionChanged"
                       SpellCheck.IsEnabled="False"/>
            </Border>

            <!-- 状态栏 -->
            <Border Grid.Row="4" 
                  Background="{DynamicResource SecondaryBackgroundBrush}"
                  CornerRadius="0,0,12,12">
                <Grid Margin="16,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" 
                             Text="{Binding PositionText}" 
                             FontSize="11"
                             Foreground="{DynamicResource SecondaryTextBrush}"
                             VerticalAlignment="Center"/>

                    <TextBlock Grid.Column="2" 
                             Text="{Binding EncodingText}" 
                             FontSize="11"
                             Foreground="{DynamicResource SecondaryTextBrush}"
                             VerticalAlignment="Center"
                             Margin="0,0,20,0"/>

                    <TextBlock Grid.Column="3" 
                             Text="{Binding StatusText}" 
                             FontSize="11"
                             Foreground="{DynamicResource PrimaryBrush}"
                             FontWeight="Medium"
                             VerticalAlignment="Center"/>
                </Grid>
            </Border>

            <!-- 窗口调整大小手柄 -->
            <Rectangle Grid.Row="4" 
                     Width="12" 
                     Height="12"
                     HorizontalAlignment="Right"
                     VerticalAlignment="Bottom"
                     Fill="Transparent"
                     Cursor="SizeNWSE"
                     Margin="0,0,2,2"
                     MouseLeftButtonDown="ResizeGrip_MouseLeftButtonDown"/>
        </Grid>
    </Border>
</Window>
